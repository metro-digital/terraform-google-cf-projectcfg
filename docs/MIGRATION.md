# Migration Instructions

<!-- mdformat-toc start --slug=github --no-anchors --maxlevel=6 --minlevel=2 -->

- [`v3` Release](#v3-release)
  - [IAM-Related Changes](#iam-related-changes)
    - [Changes to Input Variables and Attributes](#changes-to-input-variables-and-attributes)
      - [`roles` => `iam_policy`](#roles--iam_policy)
      - [`non_authoritative_roles` => `iam_policy_non_authoritative_roles`](#non_authoritative_roles--iam_policy_non_authoritative_roles)
      - [`custom_roles.members` => `custom_roles.project_iam_policy_members`](#custom_rolesmembers--custom_rolesproject_iam_policy_members)
      - [`service_accounts.iam` => `service_accounts.iam_policy`](#service_accountsiam--service_accountsiam_policy)
      - [`service_accounts.iam_non_authoritative_roles` => `service_accounts.iam_policy_non_authoritative_roles`](#service_accountsiam_non_authoritative_roles--service_accountsiam_policy_non_authoritative_roles)
      - [`service_accounts.project_roles` => `service_accounts.project_iam_policy_roles`](#service_accountsproject_roles--service_accountsproject_iam_policy_roles)
    - [De-Privilege Compute Engine Default Service Account](#de-privilege-compute-engine-default-service-account)
  - [Network-Related Changes](#network-related-changes)
    - [Firewall Rules](#firewall-rules)

<!-- mdformat-toc end -->

## `v3` Release

To prepare for a migration, ensure you have applied your Terraform configuration
with the latest version of the `v2` release series. The latest version can be
found [here][latest-v2-release].

Review the [CHANGELOG] to familiarize yourself with all the changes implemented
since the latest `v2` release.

To avoid unplanned upgrades to the `v3` release series, we took the opportunity
of a breaking release to unify attribute naming between several input variables.
This resulted in a safeguard against automatic upgrades, as previously mandatory
input variables are removed.

> [!WARNING]
> In general, we recommend using the module with a [version constraint] limiting
> potential updates to the currently used major version. See also the
> [FAQ][faq-versioning]. **There is no guarantee such a safeguard will be
> implemented with the next major release.**

**After reviewing all breaking changes below**, perform the following steps to
upgrade to the `v3` release of the module:

1. Within your Terraform code's `project.tf` file, bump the module to version to
   `~> 3.0`:

   ```hcl
   module "projectcfg" {
     source  = "metro-digital/cf-projectcfg/google"
     version = "~> 3.0"

     project_id = "cf-example-project"
     ...
   ```

   This change also ensures that you automatically receive updates for all
   minor, non-breaking `v3` versions while not automatically upgrading to a
   breaking `v4` version in the future.

1. Then, run `terraform init` within your project to pull in all the required
   dependencies. This will also allow your editor to have proper semantic
   understanding of the no longer working configurations if it has a rich
   Terraform integration.

1. **Perform all the required changes** as outlined below if they affect your
   usage of the module.

1. Run `terraform plan` to see all changes. **Carefully review them!** You will
   see that some resources will be removed (e.g. no longer compliant firewall
   rules). You should only see changes related to the breaking changes
   introduced below. If you see other changes, make sure to understand where
   those changes originate. Also, ensure that you understand the implications of
   each change on your infrastructure. If you e.g. rely on a firewall rule which
   is removed in `v3` of the module, make sure to replace it with a sensible
   alternative before proceeding! In case you are unsure about a specific
   change, don't hesitate to reach out to the [Cloud Foundation team][support].

1. **After you are sure that all changes are expected and you mitigated
   potentially negative effects on your infrastructure**, run `terraform apply`
   or use your team's roll-out mechanism (e.g. GitHub Actions).

### IAM-Related Changes

The module is now *fully authoritative* on the project's IAM policy. This is a
significant change, as the module was previously only authoritative on roles
matching the pattern `roles/.*` and custom roles generated by the module itself.
Now, the module is also authoritative on all other roles used within the
project-level IAM policy.

Support for **IAM conditions** was added for the project and service account
level IAM policies.

The module no longer uses a `google_project_iam_binding` resource per role but
generates a full IAM policy to be used with `google_project_iam_policy`. This
has several advantages:

- Significant speed-up for bigger project-level IAM policies. Terraform doesn't
  need to refresh the state of each individual binding any more.
- Better handling of permission removal, as no empty
  `google_project_iam_binding` resource is generated for role bindings that
  should not exist. These bindings caused an additional diff in the next
  Terraform execution as the resources got deleted once applied successfully.

Existing projects, when put under Terraform control using this module, can also
benefit from the usage of `google_project_iam_policy`, as you can import your
existing policy into the module to see changes done by the module. For details,
see the [FAQ][faq-iam-policy-import].

#### Changes to Input Variables and Attributes

##### `roles` => `iam_policy`

The input variable was renamed, and additionally, the type was adjusted to
support IAM conditions. Migration requires some adjustments, see below.

**Old Configuration:**

```hcl
# Old type definition:
#
# map(list(string))

roles = {
  "roles/bigquery.admin" = [
    "group:customer.project-role@cloudfoundation.metro.digital",
  ],
  "roles/cloudsql.admin" = [
    "group:customer.project-role@cloudfoundation.metro.digital",
  ]
}

```

**New Configuration:**

```hcl
# New type definition:
#
# list(object({
#   role    = string
#   members = list(string)
#   condition = optional(object({
#     title       = string
#     expression  = string
#     description = optional(string, null)
#   }), null)
# }))

iam_policy = [
  {
    role = "roles/bigquery.admin"
    members = ["group:customer.project-role@cloudfoundation.metro.digital"]
  },
  {
    role = "roles/cloudsql.admin"
    members = ["group:customer.project-role@cloudfoundation.metro.digital"]
  }
]
```

##### `non_authoritative_roles` => `iam_policy_non_authoritative_roles`

Input variable `non_authoritative_roles` was renamed for naming consistency
reasons. Type is unchanged. For migration, simply rename the input variable to
`iam_policy_non_authoritative_roles`.

##### `custom_roles.members` => `custom_roles.project_iam_policy_members`

Attribute `members` for input variable `custom_roles` was renamed for naming
consistency reasons. Type is unchanged. For migration, simply rename the
attribute to `project_iam_policy_members`.

##### `service_accounts.iam` => `service_accounts.iam_policy`

Attribute `iam` for input variable `service_accounts` was renamed for naming
consistency reasons. The type was adjusted to support IAM conditions, similar to
the `iam_policy` input variable.

The same [migration instructions](#roles--iam_policy) apply.

##### `service_accounts.iam_non_authoritative_roles` => `service_accounts.iam_policy_non_authoritative_roles`

Attribute `iam_non_authoritative_roles` for input variable `service_accounts`
was renamed for naming consistency reasons. Type is unchanged. For migration,
simply rename the attribute to `iam_policy_non_authoritative_roles`.

##### `service_accounts.project_roles` => `service_accounts.project_iam_policy_roles`

Attribute `project_roles` for input variable `service_accounts` was renamed for
naming consistency reasons. Type is unchanged. For migration, simply rename the
attribute to `project_iam_policy_roles`.

#### De-Privilege Compute Engine Default Service Account

The module no longer supports the role `roles/editor` role to be granted to the
[Compute Engine default service account]. The flag was removed, and the role is
always removed on a project level. A previous announcement mid-2024 already
promoted the deprecation of primitive roles.

When creating a Compute Engine instance, use user-managed service accounts to be
compliant with Cloud Policies:

- To set up a service account during VM creation, see
  [Create a VM that uses a user-managed service account][vm-create-user-sa].
- To set up a service account on an existing VM, see
  [Change the attached service account][vm-update-user-sa].

### Network-Related Changes

#### Firewall Rules

> [!CAUTION]
> All firewall rules related to public ingress were removed to be compliant with
> the latest Cloud Policies.

The removed firewall rules include IP ranges for networks which are generally
owned by METRO but should not automatically be considered trusted. If you need
such firewalls, you can still create similar ones. Ensure you are compliant with
the latest Cloud Policies.

Additionally, support for fine-grained configuration of created firewall rules
was added. See the `firewall_rules` [input variable](./TERRAFORM.md#inputs).

[changelog]: CHANGELOG.md
[compute engine default service account]: https://cloud.google.com/compute/docs/access/service-accounts#default_service_account
[faq-iam-policy-import]: FAQ.md#how-to-import-existing-iam-policy
[faq-versioning]: FAQ.md#versioning
[latest-v2-release]: https://github.com/metro-digital/terraform-google-cf-projectcfg/releases?q=v2&expanded=false
[support]: https://metrodigital.atlassian.net/wiki/x/BwLMBw
[version constraint]: https://developer.hashicorp.com/terraform/language/expressions/version-constraints
[vm-create-user-sa]: https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances
[vm-update-user-sa]: https://cloud.google.com/compute/docs/instances/change-service-account
